<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Vue Projecteur</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/projector.css" />
  </head>
  <body class="projector">
    <header class="proj-header">
      <div class="proj-brand">
        <img src="/logo_ink.svg" alt="INK" />
      </div>
    </header>

    <main class="proj-app">
      <div class="proj-grid">
        <div class="proj-image-panel">
          <img class="proj-image" src="/photo-qrcode.png" alt="Produit" />
        </div>

        <div class="proj-info">
          <div>
            <div class="proj-title">Timbre “ONE PENNY”</div>
            <div class="proj-desc">
              Penny Black (1840) - Premier timbre postal de l’histoire, émis au
              Royaume-Uni. Imprimé en noir sur fond blanc, il représente le
              profil de la reine Victoria.
            </div>
            <div class="proj-sep"></div>
          </div>

          <div class="enchere-temps">
            <div class="proj-meta">
              <div>Dernière enchère : <span id="projLastBidder">—</span></div>
              <div class="proj-amount">
                <span id="projAmount">1</span
                ><img class="money" src="/money.svg" alt="money" />
              </div>
            </div>
            <div class="proj-timer">
              <span>Temps restant</span>
              <span class="proj-timer-value" id="projTimer">00:30</span>
            </div>
          </div>

          <div class="proj-history" id="projHistory"></div>
        </div>
      </div>
    </main>

    <div class="proj-modal" id="winnerModal" aria-hidden="true">
      <div class="proj-modal-backdrop" data-close-modal></div>
      <div
        class="proj-modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="winnerModalTitle"
      >
        <div class="proj-modal-title" id="winnerModalTitle">
          Enchère terminée
        </div>
        <div class="proj-modal-body">
          <div class="proj-modal-row">
            <span class="label">Gagnant</span>
            <span class="value" id="winnerModalName">—</span>
          </div>
          <div class="proj-modal-row">
            <span class="label">Dernière enchère</span>
            <span class="value" id="winnerModalAmount">—</span>
          </div>
        </div>
        <button
          class="proj-modal-close"
          type="button"
          id="winnerModalClose"
          aria-label="Fermer la fenêtre"
        >
          Fermer
        </button>
      </div>
    </div>

    <script>
      const socket = io();

      // Elements
      const amountEl = document.getElementById("projAmount");
      const lastBidderEl = document.getElementById("projLastBidder");
      const historyEl = document.getElementById("projHistory");
      const timerEl = document.getElementById("projTimer");
      const winnerModal = document.getElementById("winnerModal");
      const winnerModalNameEl = document.getElementById("winnerModalName");
      const winnerModalAmountEl = document.getElementById("winnerModalAmount");
      const winnerModalCloseBtn = document.getElementById("winnerModalClose");

      // State
      let currentAmount = 1;
      let historyItems = []; // { name, inc }
      const MAX_ITEMS = 30;
      let lastBidderName = null;
      let lastBidAmount = currentAmount;

      // Timer (desktop projector mirrors jury logic - no restart on bids)
      const TIMER_SECONDS = 30;
      let timerInterval = null;
      let timerEndAtMs = null;

      function formatNumber(n) {
        return new Intl.NumberFormat("fr-FR").format(n);
      }

      function renderAmount() {
        amountEl.textContent = formatNumber(currentAmount);
      }

      function renderHistory() {
        historyEl.innerHTML = historyItems
          .slice(0, MAX_ITEMS)
          .map(
            (item) =>
              `<div class="proj-history-item"><span class="name">${item.name}</span><div><span class="inc">+${item.inc}</span><img class="money-name" src="/money-grey.svg"></div></div>`
          )
          .join("");
      }

      function formatTime(totalSeconds) {
        const clamped = Math.max(0, Math.ceil(totalSeconds));
        const m = String(Math.floor(clamped / 60)).padStart(2, "0");
        const s = String(clamped % 60).padStart(2, "0");
        return `${m}:${s}`;
      }

      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerEndAtMs = Date.now() + TIMER_SECONDS * 1000;
        timerEl.textContent = formatTime(TIMER_SECONDS);
        timerInterval = setInterval(() => {
          const remaining = Math.max(0, (timerEndAtMs - Date.now()) / 1000);
          timerEl.textContent = formatTime(remaining);
          if (remaining <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            handleTimerFinished();
          }
        }, 100);
      }

      function openWinnerModal() {
        if (!winnerModal) return;
        winnerModal.classList.add("is-open");
        winnerModal.setAttribute("aria-hidden", "false");
      }

      function closeWinnerModal() {
        if (!winnerModal) return;
        winnerModal.classList.remove("is-open");
        winnerModal.setAttribute("aria-hidden", "true");
      }

      function handleTimerFinished() {
        if (!winnerModal) return;

        const hasWinner = Boolean(lastBidderName && lastBidderName.trim());

        if (winnerModalNameEl) {
          winnerModalNameEl.textContent = hasWinner ? lastBidderName : "—";
        }

        if (winnerModalAmountEl) {
          winnerModalAmountEl.textContent = hasWinner
            ? `${formatNumber(lastBidAmount)} €`
            : "—";
        }

        openWinnerModal();
      }

      // Socket: updateBid
      socket.on("updateBid", (payload) => {
        const amount =
          payload && typeof payload === "object" ? payload.amount : payload;
        const name =
          payload && typeof payload === "object" ? payload.name : null;
        const inc = payload && typeof payload === "object" ? payload.inc : null;

        if (typeof amount === "number" && !Number.isNaN(amount)) {
          currentAmount = amount;
          renderAmount();
          lastBidAmount = currentAmount;
        }
        lastBidderEl.textContent =
          name && String(name).trim() ? name.trim() : "—";
        lastBidderName = name && String(name).trim() ? name.trim() : null;

        if (name && typeof inc === "number") {
          historyItems.unshift({ name: name.trim(), inc });
          if (historyItems.length > MAX_ITEMS) historyItems.length = MAX_ITEMS;
          renderHistory();
        }
      });

      if (winnerModalCloseBtn) {
        winnerModalCloseBtn.addEventListener("click", () => {
          closeWinnerModal();
        });
      }

      if (winnerModal) {
        winnerModal.addEventListener("click", (event) => {
          const target = event.target;
          if (
            target === winnerModal ||
            (target instanceof HTMLElement &&
              (target.dataset.closeModal !== undefined ||
                target.classList.contains("proj-modal-backdrop")))
          ) {
            closeWinnerModal();
          }
        });

        document.addEventListener("keydown", (event) => {
          if (
            event.key === "Escape" &&
            winnerModal.classList.contains("is-open")
          ) {
            closeWinnerModal();
          }
        });
      }

      // Initial render
      renderAmount();
      renderHistory();
      startTimer();
    </script>
  </body>
</html>
