<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Interface Jury</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Proposer une enchère</h1>

  <p>Enchère actuelle : <strong id="currentBidDisplay">—</strong></p>

  <div id="controls">
    <button class="inc" data-inc="50">+50</button>
    <button class="inc" data-inc="125">+125</button>
    <button class="inc" data-inc="250">+250</button>
    <button class="inc" data-inc="500">+500</button>
  </div>    

  <script>
    const socket = io();
    const currentBidDisplay = document.getElementById("currentBidDisplay");
    const buttons = document.querySelectorAll("#controls .inc");

    let currentBid = null; // synchronisé via les évènements serveur
    let bidderName = null; // prénom saisi par l'utilisateur

    const format = (n) => `${n} €`;

    const render = () => {
      currentBidDisplay.textContent = (currentBid === null || Number.isNaN(currentBid)) ? "—" : format(currentBid);
    };

    // Ecoute des mises à jour globales (acceptées par le serveur)
    socket.on("updateBid", (payload) => {
      // payload peut être un nombre (ancien format) ou un objet { amount, name }
      let amount;
      if (typeof payload === "number") {
        amount = payload;
      } else if (payload && typeof payload === "object") {
        amount = typeof payload.amount === "number" ? payload.amount : parseFloat(payload.amount);
      }
      if (!Number.isNaN(amount)) {
        currentBid = amount;
        render();
      }
    });

    // Envoi direct d'une nouvelle enchère en ajoutant l'incrément choisi
    const onClickInc = (evt) => {
      const inc = parseFloat(evt.currentTarget.getAttribute("data-inc"));
      const base = Number.isFinite(currentBid) ? currentBid : 0;
      const nextBid = base + inc;
      const nameToSend = bidderName && bidderName.trim() ? bidderName.trim() : "Anonyme";
      socket.emit("newBid", { amount: nextBid, name: nameToSend, inc });
    };

    buttons.forEach((btn) => btn.addEventListener("click", onClickInc));

    socket.on("bidRejected", ({ reason }) => {
      alert(reason || "Enchère refusée");
    });

    // Demander et mémoriser le prénom au premier chargement
    const storedName = localStorage.getItem("juryFirstName");
    if (storedName && storedName.trim()) {
      bidderName = storedName.trim();
    } else {
      const asked = prompt("Votre prénom ?");
      if (asked && asked.trim()) {
        bidderName = asked.trim();
        localStorage.setItem("juryFirstName", bidderName);
      } else {
        bidderName = "Anonyme";
      }
    }

    // Rendu initial
    render();
  </script>
</body>
</html>
