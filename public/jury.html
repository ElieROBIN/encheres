<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Interface Jury</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="app-header">
      <div class="brand">
        <img src="logo_ink.svg" alt="INK" />
      </div>
    </header>

    <main class="app">
      <div class="grid">
        <div class="product-panel">
          <img class="product-img" src="/print.png" alt="Produit" />
        </div>
        <div class="info">
          <div class="information-about-product">
            <h2 class="title">Timbre “ONE PENNY”</h2>
            <p class="desc">
              Penny Black (1840) - Premier timbre postal de l’histoire, émis au
              Royaume-Uni. Imprimé en noir sur fond blanc, il représente le
              profil de la reine Victoria.
            </p>
          </div>
          <span class="line-separation"></span>
          <div class="header-content">
            <div class="price-evolution">
            <p class="last-inc">
              Dernière enchère : <span id="lastBidder">—</span>
            </p>
            <div class="big-amount">
              <span id="bigAmount">1</span><span class="currency"><img class="money-jury" src="/money.svg" alt="money" /></span>
            </div>
            </div>
            <div class="timer">
              <p class="timer-text">Temps restant :</p>
              <span id="timer"></span>
            </div>
          </div>

          <div id="controls" class="btns">
            <button class="btn inc" data-inc="50">
              <span class="btn-inc-value">+50</span>
              <img class="btn-inc-icon" src="/money-1.svg" alt="Monnaie" />
            </button>
            <button class="btn inc" data-inc="125">
              <span class="btn-inc-value">+125</span>
              <img class="btn-inc-icon" src="/money-1.svg" alt="Monnaie" />
            </button>
            <button class="btn inc" data-inc="250">
              <span class="btn-inc-value">+250</span>
              <img class="btn-inc-icon" src="/money-1.svg" alt="Monnaie" />
            </button>
            <button class="btn inc" data-inc="500">
              <span class="btn-inc-value">+500</span>
              <img class="btn-inc-icon" src="/money-1.svg" alt="Monnaie" />
            </button>
          </div>
          <p id="bidHint" class="bid-hint">Appuyez pour enchérir</p>
        </div>
      </div>
    </main>

    <div class="app-modal" id="nameModal" aria-hidden="true">
      <div class="app-modal-backdrop" data-close-modal></div>
      <div
        class="app-modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="nameModalTitle"
      >
        <div class="app-modal-title" id="nameModalTitle">Bienvenue</div>
        <p class="app-modal-subtitle">
          Indique ton prénom pour que nous puissions l'afficher lorsqu'une enchère est validée.
        </p>
        <label class="app-modal-label" for="nameModalInput">Prénom</label>
        <input
          class="app-modal-input"
          id="nameModalInput"
          type="text"
          name="firstname"
          autocomplete="given-name"
          placeholder="Ex. Camille"
          maxlength="40"
        />
        <button class="app-modal-confirm" id="nameModalConfirm" type="button">
          Continuer
        </button>
      </div>
    </div>

    <script>
      const socket = io();
      const bigAmountEl = document.getElementById("bigAmount");
      const lastBidderEl = document.getElementById("lastBidder");
      const buttons = document.querySelectorAll("#controls .inc");
      const timerEl = document.getElementById("timer");
      const timerFillEl = document.querySelector(".timer-bar-fill");
      const bidHintEl = document.getElementById("bidHint");
      const nameModal = document.getElementById("nameModal");
      const nameModalInput = document.getElementById("nameModalInput");
      const nameModalConfirmBtn = document.getElementById("nameModalConfirm");

      let currentBid = null; // synchronisé via les évènements serveur
      let bidderName = null; // prénom saisi par l'utilisateur
      let cooldownUntilMs = 0; // anti-spam après clic
      let isTimerAllowingBids = true;
      let cooldownInterval = null;
      let timerInterval = null;
      const DEFAULT_TIMER_SECONDS = 60;
      let timerDurationMs = DEFAULT_TIMER_SECONDS * 1000;
      let timerEndAtMs = null;
      let timerRunning = false;
      let timerCompleted = false;

      const formatAmount = (n) => new Intl.NumberFormat("fr-FR").format(n);

      const render = () => {
        bigAmountEl.textContent =
          currentBid === null || Number.isNaN(currentBid)
            ? "—"
            : formatAmount(currentBid);
      };

      const updateButtonsState = () => {
        const allowedByCooldown = Date.now() >= cooldownUntilMs;
        const enabled = isTimerAllowingBids && allowedByCooldown;
        buttons.forEach((btn) => { btn.disabled = !enabled; });
        renderBidHint();
      };
      const renderBidHint = () => {
        if (!bidHintEl) return;
        if (!isTimerAllowingBids) {
          bidHintEl.textContent = "Enchères terminées";
          return;
        }
        const remaining = Math.max(0, Math.ceil((cooldownUntilMs - Date.now()) / 1000));
        if (remaining > 0) {
          bidHintEl.textContent = `Vous pourrez surenchérir dans ${remaining} seconde${remaining > 1 ? 's' : ''}`;
        } else {
          bidHintEl.textContent = "Appuyez pour enchérir";
        }
      };

      const startCooldownTicker = () => {
        if (cooldownInterval) clearInterval(cooldownInterval);
        cooldownInterval = setInterval(() => {
          renderBidHint();
          if (Date.now() >= cooldownUntilMs) {
            clearInterval(cooldownInterval);
            cooldownInterval = null;
            updateButtonsState();
          }
        }, 200);
      };


      const setButtonsEnabled = (enabled) => {
        isTimerAllowingBids = enabled;
        updateButtonsState();
      };

       const formatTime = (totalSeconds) => {
         const clamped = Math.max(0, Math.ceil(totalSeconds));
         const m = String(Math.floor(clamped / 60)).padStart(2, "0");
         const s = String(clamped % 60).padStart(2, "0");
         return `${m}:${s}`;
       };

      const renderTimer = (remainingSeconds) => {
        if (timerEl) timerEl.textContent = formatTime(remainingSeconds);
        if (timerFillEl) {
          const elapsed = Math.max(
            0,
            Math.min(
              timerDurationMs / 1000,
              timerDurationMs / 1000 - remainingSeconds
            )
          );
          const pct = (elapsed / (timerDurationMs / 1000)) * 100;
          timerFillEl.style.width = `${pct}%`;
        }
      };

      const resetTimerDisplay = () => {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        timerRunning = false;
        timerCompleted = false;
        timerEndAtMs = null;
        renderTimer(timerDurationMs / 1000);
      };

      const completeTimerCountdown = () => {
        if (!timerRunning || timerCompleted) return;
        timerCompleted = true;
        timerRunning = false;
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        timerEndAtMs = null;
        renderTimer(0);
        setButtonsEnabled(false);
      };

      const startTimerCountdown = (endAtMs, durationMs) => {
        if (typeof durationMs === "number" && durationMs > 0) {
          timerDurationMs = durationMs;
        }

        timerEndAtMs = endAtMs;
        timerRunning = true;
        timerCompleted = false;

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        setButtonsEnabled(true);

        const tick = () => {
          if (!timerRunning || timerEndAtMs === null) return;
          const remaining = Math.max(0, (timerEndAtMs - Date.now()) / 1000);
          renderTimer(remaining);
          if (remaining <= 0) {
            completeTimerCountdown();
          }
        };

        tick();
        timerInterval = setInterval(() => {
          if (!timerRunning) {
            clearInterval(timerInterval);
            timerInterval = null;
            return;
          }
          tick();
        }, 100);
      };

      const applyBidderName = (rawName) => {
        const finalName = rawName && rawName.trim() ? rawName.trim() : "Anonyme";
        bidderName = finalName;
        try {
          localStorage.setItem("juryFirstName", finalName);
        } catch (error) {
          console.warn("Impossible d'enregistrer le prénom", error);
        }
      };

      const openNameModal = () => {
        if (!nameModal) return;
        nameModal.classList.add("is-open");
        nameModal.setAttribute("aria-hidden", "false");
        requestAnimationFrame(() => {
          if (nameModalInput) {
            nameModalInput.classList.remove("is-invalid");
            nameModalInput.focus();
          }
        });
      };

      const closeNameModal = () => {
        if (!nameModal) return;
        nameModal.classList.remove("is-open");
        nameModal.setAttribute("aria-hidden", "true");
      };

      const handleNameSubmit = () => {
        if (!nameModalInput) {
          applyBidderName(bidderName);
          closeNameModal();
          return;
        }
        const value = nameModalInput.value;
        if (!value || !value.trim()) {
          nameModalInput.classList.add("is-invalid");
          nameModalInput.focus();
          return;
        }
        nameModalInput.classList.remove("is-invalid");
        applyBidderName(value);
        closeNameModal();
      };

      // Ecoute des mises à jour globales (acceptées par le serveur)
      socket.on("updateBid", (payload) => {
        // payload peut être un nombre (ancien format) ou un objet { amount, name }
        const previousBid = currentBid;
        let amount;
        let name = null;
        let inc = null;
        if (typeof payload === "number") {
          amount = payload;
        } else if (payload && typeof payload === "object") {
          amount =
            typeof payload.amount === "number"
              ? payload.amount
              : parseFloat(payload.amount);
          name = typeof payload.name === "string" ? payload.name : null;
          inc = typeof payload.inc === "number" ? payload.inc : null;
        }
        if (!Number.isNaN(amount)) {
          currentBid = amount;
          render();
        }
        lastBidderEl.textContent = name && name.trim() ? name.trim() : "—";

        // Le timer est indépendant des évènements d'enchère; aucun redémarrage ici
      });

      // Envoi direct d'une nouvelle enchère en ajoutant l'incrément choisi
      const onClickInc = (evt) => {
        if (Date.now() < cooldownUntilMs) return; // ignore pendant le cooldown
        const inc = parseFloat(evt.currentTarget.getAttribute("data-inc"));
        const base = Number.isFinite(currentBid) ? currentBid : 0;
        const nextBid = base + inc;
        const nameToSend =
          bidderName && bidderName.trim() ? bidderName.trim() : "Anonyme";
        socket.emit("newBid", { amount: nextBid, name: nameToSend, inc });
        // Active un cooldown local de 5s
        cooldownUntilMs = Date.now() + 5000;
        updateButtonsState();
        startCooldownTicker();
      };

      buttons.forEach((btn) => btn.addEventListener("click", onClickInc));

      socket.on("bidRejected", ({ reason }) => {
        alert(reason || "Enchère refusée");
      });

      socket.on("timerStarted", ({ endAt, durationMs } = {}) => {
        if (typeof endAt === "number") {
          startTimerCountdown(endAt, durationMs);
        }
      });

      socket.on("timerState", ({ endAt, durationMs } = {}) => {
        if (typeof durationMs === "number" && durationMs > 0) {
          timerDurationMs = durationMs;
        }

        if (typeof endAt === "number" && endAt > Date.now()) {
          startTimerCountdown(endAt, timerDurationMs);
        } else if (typeof endAt === "number" && endAt <= Date.now()) {
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
          timerRunning = false;
          timerCompleted = true;
          timerEndAtMs = null;
          renderTimer(0);
          setButtonsEnabled(false);
        } else {
          resetTimerDisplay();
        }
      });

      socket.on("timerEnded", () => {
        completeTimerCountdown();
      });

      if (nameModalConfirmBtn) {
        nameModalConfirmBtn.addEventListener("click", handleNameSubmit);
      }

      if (nameModalInput) {
        nameModalInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            handleNameSubmit();
          }
        });
      }

      if (nameModal) {
        nameModal.addEventListener("click", (event) => {
          const target = event.target;
          if (
            target === nameModal ||
            (target instanceof HTMLElement && target.dataset.closeModal !== undefined)
          ) {
            applyBidderName(bidderName);
            closeNameModal();
          }
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && nameModal.classList.contains("is-open")) {
            applyBidderName(bidderName);
            closeNameModal();
          }
        });
      }

      // Demander et mémoriser le prénom au premier chargement
      const storedName = localStorage.getItem("juryFirstName");
      if (storedName && storedName.trim()) {
        applyBidderName(storedName.trim());
        if (nameModalInput) {
          nameModalInput.value = storedName.trim();
        }
      } else {
        openNameModal();
      }

      // Rendu initial
      render();
      resetTimerDisplay();
      updateButtonsState();
      socket.emit("requestTimerState");
    </script>
  </body>
</html>
